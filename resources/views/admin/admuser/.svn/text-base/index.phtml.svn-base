<?php $this->render( 'include/header', true ); ?>
<?php $this->render( 'include/lefter', true );
?>
<script type="text/javascript" src="/static/js/popup_util.js"></script>
<script type="text/javascript" src="/static/js/msg_util.js"></script>
		<div id="main-content"> <!-- Main Content Section with everything -->

			<div class="content-box" style="width:100%;">
	<div class="content-box-header">
	<h3>用户查询 </h3>

	 <ul class="content-box-tabs">
			 <li><a href="/auth/index/"   class="current">浏览</a></li>

		</ul>
	</div> <!-- End .content-box-header -->
<div class="content-box-content">
	<div class="tab-content default-tab">
		<form action="/auth/index/" method="get">
		  <table width="100%" class="table01">
				<tr>
					<td> 用户名: </td>
					<td><input class="text-input small-input" type="text" name="name" id="name" value="<?php echo $this->name ;?>"/></td>
				</tr>

			<tr><td colspan=2> <input type="submit" id="button"  value=" 查   询 " /></td></tr>
		  </table>

		</form>
	</div> <!-- End #tab3 -->
</div> <!-- End .content-box-content -->
</div>
			<div class="content-box ">

				<div class="content-box-header">

					<h3>用户管理</h3>
					<ul class="content-box-tabs">
						<li><a href="/auth/index/" class="default-tab">列表</a></li> <!-- href must be unique and match the id of target div -->

					</ul>


				</div> <!-- End .content-box-header -->

				<div class="content-box-content">

					<div class="tab-content default-tab" id="refresh">

						<table id="selected">
							<tr id="lis">
								<th><h3>ID</h3></th>
								<th><h3>姓名</h3></th>
								<th><h3>拼音姓名</h3></th>
								<th><h3>部门</h3></th>
								<th><h3>职位</h3></th>
								<th><h3>系统角色</h3></th>
								<th><h3>状态</h3></th>
								<th><h3>操作</h3></th>
							</tr >
							<?php
							foreach($this->list['record'] as $v)
							{
								echo "<tr id=\"m_".$v['id']."\">";
								echo "<td>".$v['id']."</td>";
								echo "<td id=\"s_".$v['id']."\">".$v['name']."</td>";
								echo "<td>".$v['ename']."</td>";
								echo "<td>".$v['depart']."</td>";
								echo "<td>".$v['position']."</td>";
								echo "<td><span id=\"r_".$v['id']."\"><a href='javascript:' onclick='uprole(".$v['id'].",\"".$v[role]."\")'>".$v['role']."</a></span></td>";
								if($v['status']==1)
								{
									echo "<td>正常</td>";
								}else
								{
									echo "<td style='color:red'>禁用</td>";
								}

								echo "<td><a href='javascript:void(0)' onclick='selectgrade(".$v['id'].",\"".$v['ename']."\")'>添加权限</a>&nbsp;&nbsp;&nbsp;<a href='/auth/modifyauth/?uid=".$v['id']."'><img src='/static/admin/images/icons/pencil.png' title='修改权限'></a>&nbsp;&nbsp;<a href='javascript:void(0)' onclick='forbidden(".$v['id'].")'><img src='/static/admin/images/icons/cross.png' title='禁用账号'></a>&nbsp;</td>";
								echo "</tr>";
							}
							?>
						</table>
					</div> <!-- End #tab3 -->
				<hr>
				<details><summary><b>添加管理员</b></summary>
				<hr>
						<div>
							<form action = "/auth/add/" method="post" id="authform" name="authform">
							<fieldset>
								<p>姓名： <input class="text-input small-input" type="search" name="name" id="names" value="" required="required"/><span id="c_title"></span></p>
								<p>拼音姓名： <input class="text-input small-input" type="search" name="ename" id="ename" value="" required="required" onblur="check(this.value)"/>&nbsp;<span style="color:red" id="enotic">和邮箱前缀保持一致！</span></p>
								
								<p>部门： <select id="depart" name="depart" required="required">
									<option value="">--请选择--</option>
									<option value="技术">--技术--</option>
									<option value="运营">--运营--</option>
									<option value="营销">--营销--</option>
									<option value="教学">--教学--</option>
									<option value="财务">--财务--</option>
									<option value="职能">--职能--</option>
									<option value="总裁办">--总裁办--</option>
									<?php
									foreach(Auth::$campus as $campus)
									{
										echo '<option value="'.$campus['name'].'">--'.$campus['name'].'--</option>';
									}
									?>
								</select></p>
								<p>职位：<select id="position" name="position" required="required">
									<option value="">--请选择--</option>
									<option value="总裁">--总裁--</option>
									<option value="副总裁">--副总裁--</option>
									<option value="总监">--总监--</option>
									<option value="主管">--主管--</option>
									<option value="员工">--员工--</option>
									<option value="兼职">--兼职--</option>
									<option value="实习生">--实习生--</option>
								</select></p>
								<p>角色： <select id="role" name="role" required="required">
									<option value="">--请选择--</option>
									<option value="超级管理员">--超级管理员--</option>
									<option value="编辑">--编辑--</option>
								</select></p>
								
								<p><input class="button" type="button" value="新增" onclick=" return submitForm()">&nbsp;<span class="notic" style="color:red"></span></p>

							</fieldset> <!-- End #tab3 -->
							</form>
						</div>
					</details>
<?php $this->render( 'include/pager', true ); ?>
				</div> <!-- End .content-box-content -->


			</div> <!-- End .content-box -->


<?php $this->render( 'include/footer', true ); ?>
<script>
	function submitForm()
	{
		var name = $.trim($("#names").val());
		var ename = $.trim($("#ename").val());
		var depart = $.trim($("#depart").val());
		var position = $.trim($("#position").val());
		var role = $.trim($("#role").val());
		if(name=="" || ename=="" || depart=="" || position=="" ||role=="")
		{
			var notic = "所有项均不能为空!"
			$(".notic").html(notic);
			return false;
		}
		$.ajax({
			type:"GET",
			data:$("#authform").serialize(),
			url:"/auth/add/",
			dataType:"json",
			cache: false,
			success:function(data){
				if(data.code=="succ")
				{
					var str = "<tr id='s"+data.data.id+"'><td>"+data.data.id+"</td><td>"+data.data.name+"</td><td>"+data.data.ename+"</td><td>"+data.data.depart+"</td><td>"+data.data.position+"</td><td>"+data.data.role+"</td><td>正常</td><td><img src='/static/admin/images/icons/cross.png' title='删除'>&nbsp;<a href='/auth/addauth/?id="+data.data.id+"'><img src='/static/admin/images/icons/pencil.png' title='添加权限'></a></td></tr>";
					$("#lis").after(str);
					$("#name").val("");
					$("#email").val("");
					$("#depart").val("");
					$("#position").val("");
					$("#role").val("");
					MsgUtil.show(data.msg)
				}else
				{
					MsgUtil.show(data.msg)
				}
			}
		});
	}

	function selectgrade(id,admin)
	{
		$("#layerbox").show();
		var pos = $("#m_"+id).offset();
		var tops = (pos.top);
		var lefts = (pos.left)-930;
		$("#layerbox").css({top:tops})
		$.ajax({
		   type: "POST",
		   url: "/auth/addgrade/",
		   data: {'id':id,'admin':admin},
		   success: function(data){
			$("#list").html(data)
		   }
		});
	}

	function close_layer()
	{
		$("#layerbox").toggle();
	}

	function forbidden(id)
	{
		var yes = confirm("不能删除~是否禁用此人权限？");
		if(yes === true)
		{
		$.ajax({
		   type: "POST",
		   url: "/auth/forbidden/",
		   data: {'id':id},
		   dataType:"json",
		   cache: false,
		   success: function(data){
			alert(data.msg);
		   }
		});
		}
	}

	function uprole(id,name)
	{
		var str = "<input type='text' value='"+name+"' onblur='saverole(this.value,"+id+")'>";
		$("#r_"+id).html(str);
	}

	function saverole(name,id)
	{
		if(name!="")
		{
			$.ajax({
		   type: "POST",
		   url: "/auth/saverole/",
		   data: {'id':id,'name':name},
		   dataType:"json",
		   cache: false,
		   success: function(data){
			   if(data.code=="yes")
			   {
					var str = "<a>"+name+"</a>";
					 $("#r_"+id).html(str);
			   }
		   }
		});
		}else
		{
			alert("fail");
		}

	}

	function checkAll(id)
	{
		var code_Values = $("input[ck=checks"+id+"]");
		if(code_Values.length)
		{
			for(var i=0;i<code_Values.length;i++)
			{
				code_Values[i].checked = true;
			}
		}else{
				code_Values.checked = false;
		}
	}

	function check(data)
	{
		$.ajax({
		   type: "POST",
		   url: "/auth/checkname/",
		   data: {'name':data},
		   dataType:"json",
		   cache: false,
		   success: function(data){
			   if(data.code=="yes")
			   {
				 $("#enotic").html(data.msg);
				 $("#ename").focus();
			   }
			   if(data.code=="no")
			   {
				$("#enotic").html(data.msg);
			   }
		   }
		});
	}

	function checkBox(tdName){
		var tdObj = document.getElementById(tdName);
		//alert(tdObj);
		var checked = tdObj.checked;
		//alert('checked:'+checked);
		var td = document.getElementById(tdName + 'Td');
		var tdSpans = td.childNodes;
		var len = tdSpans.length;

		for(var i = 0;i<len;i++){
			 var  span  =  td.childNodes[i];
			 if(span.hasChildNodes()){
				if(span.childNodes[0].nodeName == 'INPUT'){
					if(checked){
						span.childNodes[0].checked = 'checked';
					}else{
						span.childNodes[0].checked = '';
					}
				}

			 }
		}
	}

	function checkChildBox(tdName){
		var tdObj = document.getElementById(tdName);
		var td = document.getElementById(tdName + 'Td');
		var tdSpans = td.childNodes;
		var len = tdSpans.length;
		var hasCheckedChirdNum = 0;
		var inputCount = 0;
		for(var i = 0;i<len;i++){
			var  span  =  td.childNodes[i];
			 if(span.hasChildNodes()){
				if(span.childNodes[0].nodeName == 'INPUT'){
					    ++ inputCount;
						if(span.childNodes[0].checked){
							++ hasCheckedChirdNum;
						}
				}

			 }
		}
		if(inputCount == hasCheckedChirdNum){
			tdObj.checked = 'checked';
		}else{
			tdObj.checked = '';
		}

	}
</script>

<div style="position: absolute; left:50%; margin-left:-465px; z-index: 1000099; display:none" id="layerbox">
	<div style="margin:0 0;padding:0 0" id="main-content" > <!-- Main Content Section with everything -->
		<div class="content-box ">
			<div class="content-box-header">
				<h3>添加权限</h3>
				<ul class="content-box-tabs">
		 <li><a href="javascript:void(0)" style="color:red" onclick="close_layer()">关闭</a>
		</li>

	</ul>
		</div> <!-- End .content-box-header -->
	<div class="content-box-content">
	<div id="tab" class="tab-content default-tab">
		<div id="list"></div>
		<div id="pass"></div>
	</div>
</div>